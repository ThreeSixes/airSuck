<!--
AirSuck geospatial viewer by ThreeSixes (https://github.com/ThreeSixes) and Matt Lambert <matthewjohnlambert@gmail.com>

This project is licensed under GPLv3. See COPYING for dtails.

This file is part of the airSuck project (https://github.com/ThreeSixes/airSUck).
"""
-->

<!doctype html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    
    <title>AirSuck geospatial viewer</title>
    
    <style>
      * { margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-size: 10px;
          font-family:
            Helvetica,
            Arial,
            "Lucida Grande",
            sans-serif;
        }
      
      .msgBx {
        width: 100%;
        border: 1px solid;
        border-color: #000000;
        background-color: #cccccc;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        opacity: 0.85;
      }
      
      .dbgBx {
        width: 100%;
        border: 1px solid;
        border-color: #000000;
        background-color: #cccccc;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        opacity: 0.85;
      }
      
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      
      #map {
        height: 100%;
      }
      
      .infoTable {
        border: 0px;
      }
      
      .vehInfoHeader {
        text-align: center;
        font-weight: bold;
      }
      
      .tblHeader {
        font-weight: bold;
        border: 0px;
      }
      
      .tblCell {
        border: 0px;
      }
      
       #mapStyleBox {
        text-align: left;
        font-family: Roboto, Arial, sans-serif;
        position: absolute;
        top: 20px!important;
        left: 5px!important;
      }
      
      .mapStyleSelector {
        font-size: 12px;
      }
    
    </style>
    
    <!-- Include jQuery because normal JS sucks. -->
    <script src="jquery-2.1.4.min.js" type="text/javascript"></script>
    
    <!-- Include the Socket.IO JS package -->
    <script src="socket.io/socket.io.js" type="text/javascript"></script>
    
    <!-- Include the Google Maps API -->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?&callback=initMap&signed_in=true" async defer></script>
    
    <!-- Include color ramp system rainbowvis-js -->
    <script src="rainbowvis.js" type="text/javascript"></script>
  
  </head>
  <body>
    <!-- The Giggle map goes here. -->
    <div id="map"></div>
    
    <form>
      <input type="text" class="dbgBx" id="debugBx" value="Debug stream..." />
      <!-- We're magically making the message appear here. -->
      <input type="text" class="msgBx" id="message" value="Waiting for message data..." />
    </form>
    
    <script type="text/javascript">      
      // Instanciate Socket.IO
      var socket = io();
      
      // Instanciate RainbowVis and set global color ramp by plane height
      var polyRamp = new Rainbow();
      polyRamp.setNumberRange(0,45);
      polyRamp.setSpectrum('aqua', 'yellow', 'fuchsia', 'red');
      
      // Global Google Maps objects are global. :)
      var map = null;
      var mapLoaded = false;
      
      // Color settings for icons active and inactive.
      var activeVehicle = "#ff0000";
      var inactiveVehicle = "#660000";
      
      // Create a generic array to hold our vehicle data.
      var vehData = {};
      
      // Find the debugger box.
      var debugBox = document.getElementById("debugBx");
      
      // Find the target message box
      var msgBox = document.getElementById("message");
      
      // Max age of vehicles in minutes.
      var vehAge = 2 * (60 * 1000);
      
      // How often we should check for expired vehicles in seconds.
      var vehExpireCheckInterval = 1 * 1000;
      
      // Initialize the Google map.
      function initMap() {
       console.log("Maps loading...");
        
        // Set up the map object.
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 9,
          center: {lat: 45.555080, lng: -122.115890},
          mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
            mapTypeIds: [google.maps.MapTypeId.TERRAIN, google.maps.MapTypeId.SATELLITE]
            },
          mapTypeControl: false
        });
        
        // Set default map to terrain.
        map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
        
        // Create the monochrome map style
        var monoStyle = [
          {
            "featureType": "landscape.man_made",
            "elementType": "geometry",
            "stylers": [
              { "color": "#808080" },
              { "lightness": 35 }
            ]
          },{
            "featureType": "landscape.natural",
            "elementType": "geometry",
            "stylers": [
              { "color": "#808080" },
              { "lightness": 58 }
            ]
          },{
            "featureType": "poi.park",
            "stylers": [
              { "visibility": "off" }
            ]
          },{
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [
              { "color": "#444444" }
            ]
          },{
            "featureType": "water",
            "elementType": "labels",
            "stylers": [
              { "color": "#e0e0e0" }
            ]
          },{
            "featureType": "road.local",
            "elementType": "geometry",
            "stylers": [
              { "color": "#ffffff" }
            ]
          },{
            "featureType": "road.arterial",
            "elementType": "geometry",
            "stylers": [
              { "color": "#ffffff" }
            ]
          },{
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [
              { "color": "#ffffff" }
            ]
          },{
            "featureType": "road.highway",
            "elementType": "labels",
            "stylers": [
              { "visibility": "off" }
            ]
          },{
            "featureType": "road.arterial",
            "elementType": "labels",
            "stylers": [
              { "visibility": "off" }
            ]
          },{
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [
              { "color": "#808080" },
              { "lightness": 22 }
            ]
          }
        ];
       
        // Create the map style control div to override the default google maps control
        // DOM elements must be set as JS vars to pass through google maps functions
        // Set up the main style control container
        var styleControlContainer = document.createElement('div');
        styleControlContainer.id = 'mapStyleBox';
        styleControlContainer.className = 'mapControlStyle';
        styleControlContainer.index = 1000;
        
        // Create a select box container
        var styleSelectBox = document.createElement('select');
        styleSelectBox.className = 'mapStyleSelector';
        
        // Set up the map style options
        var terrainMap = document.createElement('option');
        terrainMap.className = 'mapStyleSelector';
        terrainMap.value = 'Terrain';
        terrainMap.innerHTML = 'Terrain';
        var satelliteMap = document.createElement('option');
        satelliteMap.className = 'mapStyleSelector';
        satelliteMap.value = 'Satellite';
        satelliteMap.innerHTML = 'Satellite';
        var monoMap = document.createElement('option');
        monoMap.className = 'mapStyleSelector';
        monoMap.value = 'Monochrome';
        monoMap.innerHTML = 'Monochrome';
        
        // Add the style options to the main style control container
        styleControlContainer.appendChild(styleSelectBox);
        styleSelectBox.appendChild(terrainMap);
        styleSelectBox.appendChild(satelliteMap);
        styleSelectBox.appendChild(monoMap);
        
        // Add a listener to change the map type via the select box
        styleSelectBox.addEventListener('change',function(e){
            switch (this.value) {
              case "Terrain":
                // load the terrain map and clear any style overrides
                map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
                map.set('styles',null);
                break;
              case "Satellite":
                // load the satellite map and clear any style overrides
                map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                map.set('styles',null);
                break;
              case "Monochrome":
                // load the terrain map and add a custom style
                map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
                map.set('styles',monoStyle);
                break;
              default:
                map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
                map.set('styles',null);
            }
          });
        
        // Load the custom controls through the map controls interface
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(styleControlContainer);
        
        // Set default map to monochrome.
        map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
        map.set('styles',monoStyle);
        // Set the selectbox to monochrome
        styleSelectBox.options[2].selected = true;
        
        // The map loaded.
        mapLoaded = true;
      }
      
      // Create icons for vehicles.
      function iconFactory(vehName) {
        var newIcon = null;
        var iconPath = null;
        var vehColor = inactiveVehicle;
        
        // If we're active make the icon bright red, else dark red.
        if (vehData[vehName].active == true) {
          vehColor = activeVehicle; 
        }
        
        // If we have heading data for the vehicle
        if ('heading' in vehData[vehName]) {
          // Create our icon for a vehicle with heading data.
          newIcon = new google.maps.Marker({
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 1.5,
            strokeColor: vehColor,
            rotation: vehData[vehName].heading
          });
        } else {
          // Create our icon for a vehicle without heading data.
          newIcon = new google.maps.Marker({
            path: google.maps.SymbolPath.CIRCLE,
            scale: 3.0,
            strokeColor: vehColor
          });
        }
        
        // And return it.
        return newIcon;
      }
      
      
      // Create info windows for vehicles.
      function infoFactory(vehName) {
        var retVal = null;
        
        // Which position type do we have?
        // ADS-B/SSR
        if (vehData[vehName].type == "airSSR") {
          // Build an aircraft identity string.
          var idStr = "";
          var catStr = "--";
          var fsStr = "-";
          var altStr = "--";
          var vertRateStr = "--";
          var vrSign = "";
          var veloStr = "--";
          var headingStr = "--";
          var vertStatStr = "--";
          var posStr = "";
          var supersonicStr = "--";
          
          // If we have a plane/flight ID
          if ("idInfo" in vehData[vehName]) {
            idStr += vehData[vehName].idInfo + " ";
          }
          
          // And if we have a squawk code...
          if ("aSquawk" in vehData[vehName]) {
            idStr += "(" + vehData[vehName].aSquawk + ") ";
          }
          
          // We should always have an ICAO address.
          idStr += "[" + vehData[vehName].addr.toUpperCase() + "]";
          
          // If we have flight status data...
          if ("fs" in vehData[vehName]) {
            fsStr = vehData[vehName].fs;
          }
          
          // If we have category data...
          if ("category" in vehData[vehName]) {
            catStr = vehData[vehName].category;
          }
          
          // If we have altitude data...
          if ("alt" in vehData[vehName]) {
            altStr = vehData[vehName].alt;
          }
          
          // If we have vertical rate data...
          if ("vertRate" in vehData[vehName]) {
            if (vehData[vehName].vertRate > 0) {
              vrSign = "+";
            }
            vertRateStr = vrSign + vehData[vehName].vertRate;
          }
          
          // If we have velocity data...
          if ("velo" in vehData[vehName]) {
            veloStr = vehData[vehName].velo;
          }
          
          // If we have vertical status data...
          if ("vertStat" in vehData[vehName]) {
            vertStatStr = vehData[vehName].vertStat;
          }
          
          // If we have heading data...
          if ("heading" in vehData[vehName]) {
            headingStr = vehData[vehName].heading;
          }
          
          // If we have position data...
          if ("lat" in vehData[vehName]) {
            posStr = vehData[vehName].lat.toFixed(7) + ", " + vehData[vehName].lon.toFixed(7);
          }
          
          // If we have supersonic data...
          if ("supersonic" in vehData[vehName]) {
            if (vehData[vehName].supersonic == 0) {
              supersonicStr = "No";
            } else if (vehData[vehName].supersonic == 1) {
              supersonicStr = "Yes";
            }
          }
          
          // Build our table.
          retVal = "<table class=\"infoTable\">";
          retVal += "<tr><td colspan=4 class=\"vehInfoHeader\">" + idStr + "</td></td></tr>";
          retVal += "<tr><td class=\"tblHeader\">Category</td><td class=\"tblCell\">" + catStr + "</td><td class=\"tblHeader\">Flight status</td><td class=\"tblCell\">" + fsStr + "</td></tr>";
          retVal += "<tr><td class=\"tblHeader\">Velocity</td><td class=\"tblCell\">" + veloStr + " kt</td><td class=\"tblHeader\">Heading</td><td class=\"tblCell\">" + headingStr + " deg</td></tr>";
          retVal += "<tr><td class=\"tblHeader\">Altitude</td><td class=\"tblCell\">" + altStr + " ft</td><td class=\"tblHeader\">Climb rate</td><td class=\"tblCell\">" + vertRateStr + " ft/min</td></tr>";
          retVal += "<tr><td class=\"tblHeader\">Position</td><td colspan=3 class=\"tblCell\">" + posStr + "</td></tr>";
          retVal += "<tr><td class=\"tblHeader\">Air/Gnd</td><td class=\"tblCell\">" + vertStatStr + "</td><td class=\"tblHeader\">Supersonic</td><td class=\"tblCell\">" + supersonicStr + "</td></tr>";
          
          // If we have Mode A metadata...
          if ("aMeta" in vehData[vehName]) {
            retVal += "<tr><td class=\"tblHeader\">Metadata</td><td class=\"tblCell\" colspan=3>Mode A - " + vehData[vehName].aMeta + "</td></tr>";
          }
          
          retVal += "</table>";
        }
        
        
        // Return information to be included in the infoWindow's contents.
        return retVal;
      }
      
      // Expire vehicles.
      function expireVehicles() {
        // Set the time we started the process of checking.
        var checkStart = new Date().getTime();
        
        // Loop through every vehicle we have data on
        for (var veh in vehData) {
          // Compute the time delta and set up halflife.
          var vehDelta = checkStart - vehData[veh].lastUpdate;
          var vehHalflife = vehAge / 2;
          var vehNotNuked = true;
          var changed = false;
          
          // Check to see if we haven't heard from them in our age time.
          if (vehDelta >= vehAge) {
            
            // Close an open info window, nuke the marker for the expred vehicle, and nuke the vehicle's object.
            vehData[veh].info.close();
            vehData[veh].marker.setMap(null);
            vehData[veh].pathPoly.setVisible(false);
            vehData[veh] = null;
            delete vehData[veh];
            vehNotNuked = false;
            
          } else if ((vehDelta >= vehHalflife) && (vehData[veh].active == true)) {
            
            // Deactivate vehicle and change the icon for it.
            vehData[veh].active = false;
            vehData[veh].marker.setIcon(iconFactory(veh));
            changed = true;
          } else {
            // If it's marked as inactive the reactivate it.
            if ((vehDelta < vehHalflife) && (vehData[veh].active == false)) {
              
              // Activate vehicle and change the icon for it.
              vehData[veh].active = true;
              vehData[veh].marker.setIcon(iconFactory(veh));
              changed = true;
            }
          }
          
          // If we have position data
          if (changed && vehNotNuked && vehData[veh].lat) {
            // Create Google maps position object.
            var newPos = new google.maps.LatLng(vehData[veh].lat, vehData[veh].lon);
            
            // Redraw the marker and move inte infowindow.
            vehData[veh].marker.setPosition(newPos);
            vehData[vehName].info.setPosition(newPos);
          }
        }
      }
      
      
      function handleMessage(msg){
        if (!mapLoaded) {
          console.log("Maps not loaded. Discarding aircraft data.");
          return;
        }
        
        // Dump the JSON string to the message box.
        msgBox.value = msg;
        
        // JSONify the JSON string.
        msgJSON = JSON.parse(msg);
        
        // Don't continue processing the keepalive.
        if ('keepalive' in msgJSON) {
          return;
        }
        
        // Vehicle name
        vehName = "veh" + msgJSON.addr;
        
        // See if we have a vehicle in our vehicle data.
        // #### This decides to update an object or create a new one as necessary. Updates to the info window and such should be here.
        if (vehName in vehData) {
          // Update the properties for the aircraft.
          $.extend(true, vehData[vehName], msgJSON, {lastUpdate: new Date().getTime()});
          
          // Set the content box.
          vehData[vehName].info.setContent(infoFactory(vehName));
        } else {
          // Add a new vehicle.
          vehData[vehName] = {
            lastPos: "none",
            lastUpdate: new Date().getTime(),
            active: true,
            pathPoly: new google.maps.Polyline({
              map: map,
              clickable: false,
              draggable: false,
              editable: false,
              geodesic: false,
              strokeOpacity: 0.8,
              strokeWeight: 2.0,
              visible: false,
              zIndex: 1000,
              path: new google.maps.MVCArray()
            })
          };
          
          // Create objects for the aircraft's marker and current data as well as a flag for position changes, etc.
          $.extend(true, vehData[vehName], msgJSON);
          
          // Create our marker.
          aMarker = new google.maps.Marker({
            icon: iconFactory(vehName, true),
            map: map,
            vehName: vehName
          });
            
          // Create our info window.
          var infowindow = new google.maps.InfoWindow({
            content: "",
            shown: false
          });
          
          // Add listener to marker to open info window
          aMarker.addListener('click', function() {
            // If our infoWindow is being shown...
            if (vehData[this.vehName].info.shown) {
              // Close it.
              vehData[this.vehName].info.close();
              vehData[this.vehName].info.shown = false;
            } else {
              // Else, open it.
              vehData[this.vehName].info.open(map, vehData[this.vehName].marker);
              vehData[this.vehName].info.shown = true;
            }
          });
          
          // Add listener to marker to show the path
          aMarker.addListener('rightclick', function() {
            // Check to see if the path is visible and reverse the visiblity
            if (vehData[this.vehName].pathPoly.getVisible() == true) {
              vehData[this.vehName].pathPoly.setVisible(false);
            } else {
              vehData[this.vehName].pathPoly.setVisible(true);
            }
          });
          
          // Run a second extend operation to set the marker and info window
          $.extend(true, vehData[vehName], {marker: aMarker, info: infowindow});
          
          // Set the content box.
          vehData[vehName].info.setContent(infoFactory(vehName));
        }
        
        // If we have latitude and by extension longitude data...
        if (("lat" in vehData[vehName]) && mapLoaded) {
          
          // Figure out where we are in 2D space to determine whether or not we should move the marker.
          var thisPos = vehData[vehName].lat + "," + vehData[vehName].lon;
          
          // If we have new position daa...
          if (vehData[vehName].lastPos != thisPos) {
            var storePoint = [null, null, null]; // Lat, Lon, Alt
            var storeAlt = null;
            
            // If we have altitude data, we should store it.
            if ("alt" in vehData[vehName]) {
              storeAlt = vehData[vehName].alt;
            }
            
            // Create a new Google Maps LatLng object to use for the next two steps:
            newPos = new google.maps.LatLng(vehData[vehName].lat, vehData[vehName].lon);
            
            // copy the path object
            var pathObject = vehData[vehName].pathPoly.getPath();
            
            // update with the new path
            pathObject.push(newPos);
            
            // push back to the polyline
            vehData[vehName].pathPoly.setPath(pathObject);
            
            // TESTING COLOR - set by height
            vehData[vehName].pathPoly.setOptions({strokeColor: "#" + polyRamp.colourAt(vehData[vehName].alt/1000)});
            
            // Modify the icon to have the correct rotation, and to indicate there's bearing data.
            vehData[vehName].marker.setIcon(iconFactory(vehName, true));
            
            // Set the 2D data with what we have now.
            vehData[vehName].lastPos = thisPos;
            
            // Move the marker.
            vehData[vehName].marker.setPosition(newPos);
            
            // Set the initial location of the info window
            vehData[vehName].info.setPosition(newPos);
            
          }
        }
      }
      
      // When we get a message, put it in the box.
      socket.on('message', handleMessage);
      
      // Start the vehcile expiration routine which should be executed at the specified interval.
      window.setInterval(function(){
        // If our map has been loaded then we can start "expiring" vehicles.
        if (mapLoaded) { expireVehicles(); }
      }, vehExpireCheckInterval);
    
    </script>
  </body>
</html>
